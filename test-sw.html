<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Service Worker - Cocktail Finder</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üß™ Test del Service Worker - Cocktail Finder</h1>
    
    <div class="test-section">
        <h2>Estado del Service Worker</h2>
        <div id="sw-status">Verificando...</div>
        <button onclick="checkServiceWorker()">üîÑ Verificar SW</button>
        <button onclick="clearCaches()">üóëÔ∏è Limpiar Cach√©</button>
    </div>
    
    <div class="test-section">
        <h2>Recursos Cacheados</h2>
        <div id="cached-resources">Verificando cach√©...</div>
        <button onclick="checkCache()">üì¶ Ver Cach√©</button>
    </div>
    
    <div class="test-section">
        <h2>Test de Red</h2>
        <div id="network-test">Listo para probar</div>
        <button onclick="testAppShell()">üè† Test App Shell</button>
        <button onclick="testAPI()">üåê Test API</button>
        <button onclick="testOffline()">üì± Simular Offline</button>
    </div>
    
    <div class="test-section">
        <h2>Log del Service Worker</h2>
        <div id="sw-logs" style="max-height: 300px; overflow-y: auto; background: #f5f5f5; padding: 10px;">
            Los logs aparecer√°n aqu√≠...
        </div>
        <button onclick="clearLogs()">üßπ Limpiar Logs</button>
    </div>

    <script>
        let logs = [];
        
        // Interceptar console.log para mostrar logs del SW
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            logs.push(new Date().toLocaleTimeString() + ': ' + args.join(' '));
            updateLogs();
        };
        
        function updateLogs() {
            const logsDiv = document.getElementById('sw-logs');
            logsDiv.innerHTML = logs.slice(-20).join('<br>'); // Mostrar √∫ltimos 20 logs
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function clearLogs() {
            logs = [];
            updateLogs();
        }
        
        async function checkServiceWorker() {
            const statusDiv = document.getElementById('sw-status');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    
                    if (registrations.length === 0) {
                        statusDiv.innerHTML = '<div class="error">‚ùå No hay Service Workers registrados</div>';
                        return;
                    }
                    
                    let status = '<div class="success">‚úÖ Service Workers encontrados:</div>';
                    
                    for (let reg of registrations) {
                        status += `<div class="info">
                            üìç Scope: ${reg.scope}<br>
                            üèÉ Estado: ${reg.active ? 'Activo' : 'Inactivo'}<br>
                            üì¶ Cach√©: ${reg.active ? 'Funcionando' : 'No disponible'}
                        </div>`;
                    }
                    
                    statusDiv.innerHTML = status;
                } catch (error) {
                    statusDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                }
            } else {
                statusDiv.innerHTML = '<div class="error">‚ùå Service Workers no soportados</div>';
            }
        }
        
        async function clearCaches() {
            try {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                console.log('‚úÖ Todos los caches eliminados');
                document.getElementById('sw-status').innerHTML = '<div class="success">‚úÖ Cach√© limpiado. Recarga la p√°gina.</div>';
            } catch (error) {
                console.error('‚ùå Error limpiando cach√©:', error);
            }
        }
        
        async function checkCache() {
            const resourcesDiv = document.getElementById('cached-resources');
            
            try {
                const cacheNames = await caches.keys();
                
                if (cacheNames.length === 0) {
                    resourcesDiv.innerHTML = '<div class="error">‚ùå No hay caches disponibles</div>';
                    return;
                }
                
                let resources = '<div class="success">üì¶ Recursos cacheados:</div>';
                
                for (let cacheName of cacheNames) {
                    const cache = await caches.open(cacheName);
                    const keys = await cache.keys();
                    
                    resources += `<div class="info"><strong>${cacheName}</strong> (${keys.length} recursos):<ul>`;
                    
                    for (let key of keys) {
                        resources += `<li>üìÑ ${key.url}</li>`;
                    }
                    
                    resources += '</ul></div>';
                }
                
                resourcesDiv.innerHTML = resources;
            } catch (error) {
                resourcesDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function testAppShell() {
            const testDiv = document.getElementById('network-test');
            testDiv.innerHTML = '<div class="info">üß™ Probando recursos App Shell...</div>';
            
            const appShellResources = [
                '/index.html',
                '/main.js',
                'https://cdn.tailwindcss.com',
                '/assets/manifest.json'
            ];
            
            let results = '';
            
            for (let resource of appShellResources) {
                try {
                    const response = await fetch(resource);
                    const status = response.ok ? '‚úÖ' : '‚ùå';
                    const source = response.headers.get('X-Offline-CSS') ? '(Offline CSS)' : 
                                  response.url.includes('cache') ? '(Cach√©)' : '(Red)';
                    results += `${status} ${resource} ${source}<br>`;
                } catch (error) {
                    results += `‚ùå ${resource} - Error: ${error.message}<br>`;
                }
            }
            
            testDiv.innerHTML = `<div class="info">Resultados App Shell:<br>${results}</div>`;
        }
        
        async function testAPI() {
            const testDiv = document.getElementById('network-test');
            testDiv.innerHTML = '<div class="info">üß™ Probando API...</div>';
            
            try {
                const response = await fetch('https://www.thecocktaildb.com/api/json/v1/1/search.php?s=margarita');
                const data = await response.json();
                
                if (response.headers.get('X-Offline-Response') === 'true') {
                    testDiv.innerHTML = '<div class="info">üì± API respondi√≥ con datos offline</div>';
                } else {
                    testDiv.innerHTML = `<div class="success">‚úÖ API funcionando - Encontrados ${data.drinks ? data.drinks.length : 0} c√≥cteles</div>`;
                }
            } catch (error) {
                testDiv.innerHTML = `<div class="error">‚ùå API fall√≥: ${error.message}</div>`;
            }
        }
        
        function testOffline() {
            const testDiv = document.getElementById('network-test');
            testDiv.innerHTML = `
                <div class="info">
                    üì± Para probar modo offline:
                    <ol>
                        <li>Abre DevTools (F12)</li>
                        <li>Ve a la pesta√±a "Network"</li>
                        <li>Marca "Offline" checkbox</li>
                        <li>Usa los botones de arriba para probar</li>
                        <li>La app debe seguir funcionando</li>
                    </ol>
                </div>
            `;
        }
        
        // Auto-verificar al cargar
        window.addEventListener('load', () => {
            checkServiceWorker();
            setTimeout(checkCache, 1000);
        });
    </script>
</body>
</html>